<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Réservation - À l'Orée de la Forêt</title>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
:root {
  --vert-clair: #cfead2;
  --vert-fonce: #5c8a63;
  --brun-texte: #4a3c31;
}
body {
  font-family: 'Roboto', sans-serif;
  background: #ffffff;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 2rem;
}
.form-container {
  background: var(--vert-clair);
  border-radius: 24px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
  max-width: 520px;
  width: 100%;
  padding: 2rem 2.5rem;
  text-align: center;
}
.form-container img {
  max-width: 140px;
  height: auto;
  margin-bottom: 1rem;
}
.header-images {
  display: flex;
  align-items: center;   
  gap: 20px;             
  justify-content: center; 
}
.header-images img {
  max-height: 90px;      
  height: auto;
}
h1 {
  color: var(--brun-texte);
  font-size: 1.5rem;
  margin-bottom: 1rem;
  line-height: 1.3;
}
.subtitle-script {
  display: block;
  font-size: 0.85rem;
  color: var(--brun-texte);
  margin-top: 0.3rem;
}
#encartFermeture {
  border: 2px solid #b6dab8;
  border-radius: 12px;
  padding: 1rem;
  text-align: left;
  margin-bottom: 1.5rem;
  font-size: 0.75rem;
  color: var(--brun-texte);
  background: #fff;
}
label {
  display: block;
  text-align: left;
  color: var(--brun-texte);
  font-weight: 500;
  margin-top: 1rem;
  margin-bottom: 0.3rem;
}
input, select, textarea {
  width: 100%;
  padding: 0.7rem 0.9rem;
  border-radius: 12px;
  border: 1px solid #c9b6a4;
  background-color: #fff;
  font-size: 1rem;
  box-sizing: border-box;
}
button {
  background: linear-gradient(135deg, var(--vert-clair), var(--vert-fonce));
  color: white;
  border: none;
  padding: 0.8rem 1rem;
  border-radius: 14px;
  font-size: 1.1rem;
  font-weight: bold;
  margin-top: 1.8rem;
  width: 100%;
  cursor: pointer;
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}
button:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
#message { margin-top: 1rem; font-weight: 500; }
.success { color: #2e7d32; }
.error { color: #b71c1c; }
.datetime-group { display: flex; flex-direction: column; margin-top: 1rem; }
.datetime-fields { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.datetime-fields input, .datetime-fields select { flex: 1; }
.datetime-fields input { border-radius: 12px 0 0 12px; border-right: none; }
.datetime-fields select { border-radius: 0 12px 12px 0; }
.popup {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.4);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
.popup-content {
  background:#fff;
  padding:1.8rem 2rem;
  border-radius:12px;
  max-width:400px;
  text-align:left;
}
.popup-content button {
  margin-top:1rem;
  width:auto;
}
</style>
</head>

<body>
<div class="form-container">
    <div class="header-images">
      <img src="logoCarre.png" alt="Logo À l'Orée de la Forêt" class="logo" />
      <img src="reservationVacances.jpg" alt="Reservation de mes vacances" class="second-image" />
    </div>

  <h1>
    À l’Orée de la Forêt<br>
    <span class="subtitle-script">Pension canine familiale - Cheillé</span>
    <span class="subtitle-script">Demande de réservation</span>
  </h1>
  <div id="encartFermeture"></div>
  <form id="reservationForm">
    <label>Nom et prénom du propriétaire</label>
    <input type="text" name="nom_proprietaire" required />
    <label>Email</label>
    <input type="email" name="email" required />
    <label>Nombre de chiens</label>
    <input type="number" name="nb_chien" min="1" value="1" required />
    <div id="nomsChiensContainer"></div>

    <div class="datetime-group">
      <label>Arrivée</label>
      <div class="datetime-fields">
        <input type="date" id="dateArrivee" name="date_arrivee" required />
        <select id="heureArrivee" name="heure_arrivee" required></select>
      </div>
    </div>

    <div class="datetime-group">
      <label>Départ</label>
      <div class="datetime-fields">
        <input type="date" id="dateDepart" name="date_depart" required />
        <select id="heureDepart" name="heure_depart" required></select>
      </div>
    </div>

    <label>Remarque</label>
    <textarea name="remarque"></textarea>

    <button type="submit">Envoyer la réservation</button>
  </form>
  <div id="message"></div>
</div>

<script>
// --- Supabase & EmailJS ---
const SUPABASE_URL = 'https://usatdvopaaxrxjiqhgju.supabase.co';
const SUPABASE_ANON_KEY = 'VOTRE_CLE_SUPABASE';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
emailjs.init("VOTRE_CLE_EMAILJS");

// --- Fermetures ---
const encartFermeture = document.getElementById("encartFermeture");
const periodesFermees = [
  { debut: "2025-12-20", fin: "2025-12-26" },
  { debut: "2026-02-22", fin: "2026-02-28" },
  { debut: "2026-04-18", fin: "2026-04-26" },
  { debut: "2026-05-27", fin: "2026-05-31" },
  { debut: "2026-07-03", fin: "2026-07-23" },
  { debut: "2026-10-16", fin: "2026-10-24" },
  { debut: "2026-12-19", fin: "2026-12-27" }
];
function afficherEncartFermeture() {
  let contenu="";
  periodesFermees.forEach(p=>{
    const options={ day:"numeric", month:"long" };
    let debut=new Date(p.debut).toLocaleDateString("fr-FR",options).replace(/^1 /,"1er ");
    let fin=new Date(p.fin).toLocaleDateString("fr-FR",options).replace(/^1 /,"1er ");
    contenu += `Du ${debut} au ${fin}<br>`;
  });
  encartFermeture.innerHTML = contenu;
}
afficherEncartFermeture();

// --- Noms chiens dynamiques ---
const nbChienInput = document.querySelector('input[name="nb_chien"]');
const nomsChiensContainer = document.getElementById("nomsChiensContainer");
function updateNomsChiens() {
  let nb=parseInt(nbChienInput.value)||1;
  if(nb<1) nb=1;
  nbChienInput.value=nb;
  nomsChiensContainer.innerHTML="";
  for(let i=1;i<=nb;i++){
    const label=document.createElement("label");
    label.textContent= nb===1?"Nom du chien":`Nom du chien ${i}`;
    const input=document.createElement("input");
    input.type="text"; input.name=`nom_chien_input_${i}`; input.required=true;
    nomsChiensContainer.appendChild(label); nomsChiensContainer.appendChild(input);
  }
}
nbChienInput.addEventListener("input", updateNomsChiens);
updateNomsChiens();

// --- Dates & heures ---
const dateArriveeInput=document.getElementById("dateArrivee");
const dateDepartInput=document.getElementById("dateDepart");
const heureArriveeSelect=document.getElementById("heureArrivee");
const heureDepartSelect=document.getElementById("heureDepart");

const todayStr = new Date().toISOString().split("T")[0];
dateArriveeInput.value=todayStr; dateDepartInput.value=todayStr;
dateArriveeInput.min=todayStr; dateDepartInput.min=todayStr;

// --- Horaires simplifiés ---
const horaires = {
  arrivee: {
    lundi: [["09:00","14:00"], ["16:00","17:00"]],
    mardi: [["09:00","14:00"], ["16:00","17:00"]],
    mercredi: [["09:00","14:00"], ["17:00","18:45"]],
    jeudi: [["09:00","14:00"], ["17:00","18:45"]],
    vendredi: [["09:00","14:00"], ["17:00","18:45"]],
    samedi: [["10:00","12:00"], ["17:00","18:00"]],
    dimanche: [["17:00","18:00"]],
    ferie: [["17:00","18:00"]]
  },
  depart: {
    lundi: [["09:00","14:00"], ["16:00","17:00"]],
    mardi: [["09:00","14:00"], ["16:00","17:00"]],
    mercredi: [["09:00","14:00"], ["17:00","18:45"]],
    jeudi: [["09:00","14:00"], ["17:00","18:45"]],
    vendredi: [["09:00","14:00"], ["17:00","18:45"]],
    samedi: [["10:00","12:00"], ["17:00","18:00"]],
    dimanche: [["11:00","12:00"], ["17:00","18:00"]],
    ferie: [["11:00","12:00"], ["17:00","18:00"]]
  }
};

function parseTime(dateStr,timeStr){
  const [h,m]=timeStr.split(":").map(Number);
  const date=new Date(dateStr); date.setHours(h,m,0,0);
  return date;
}

function generateCreneaux(dateStr,plages){
  const creneaux=[];
  plages.forEach(plage=>{
    let start=parseTime(dateStr,plage[0]);
    const end=parseTime(dateStr,plage[1]);
    while(start<=end){
      const hh=start.getHours().toString().padStart(2,"0");
      const mm=start.getMinutes().toString().padStart(2,"0");
      creneaux.push(`${hh}h${mm}`);
      start.setMinutes(start.getMinutes()+15);
    }
  });
  return creneaux;
}

function getDayType(dateStr){
  const date=new Date(dateStr);
  const day=date.getDay();
  const isFerie=periodesFermees.some(p=>{
    const debut=new Date(p.debut), fin=new Date(p.fin);
    return date>=debut && date<=fin;
  });
  if(isFerie) return "ferie";
  switch(day){
    case 0: return "dimanche";
    case 1: return "lundi";
    case 2: return "mardi";
    case 3: return "mercredi";
    case 4: return "jeudi";
    case 5: return "vendredi";
    case 6: return "samedi";
  }
}

function updateHeures(){
  // Arrivée
  const arrPlages = horaires.arrivee[getDayType(dateArriveeInput.value)];
  const arrCreneaux = generateCreneaux(dateArriveeInput.value, arrPlages);
  heureArriveeSelect.innerHTML="";
  arrCreneaux.forEach(h=>{
    const opt=document.createElement("option"); opt.value=h; opt.textContent=h;
    heureArriveeSelect.appendChild(opt);
  });

  // Départ
  const depPlages = horaires.depart[getDayType(dateDepartInput.value)];
  const depCreneaux = generateCreneaux(dateDepartInput.value, depPlages).filter(h=>{
    const [h1,m1]=h.split("h").map(Number);
    const [h2,m2]=heureArriveeSelect.value.split("h").map(Number);
    return dateDepartInput.value>dateArriveeInput.value || h1>h2 || (h1===h2 && m1>m2);
  });
  heureDepartSelect.innerHTML="";
  depCreneaux.forEach(h=>{
    const opt=document.createElement("option"); opt.value=h; opt.textContent=h;
    heureDepartSelect.appendChild(opt);
  });
  if(depCreneaux.length>0) heureDepartSelect.value=depCreneaux[0];
}

dateArriveeInput.addEventListener("change", ()=>{
  if(dateDepartInput.value<dateArriveeInput.value) dateDepartInput.value=dateArriveeInput.value;
  dateDepartInput.min=dateArriveeInput.value;
  updateHeures();
});
dateDepartInput.addEventListener("change", updateHeures);
heureArriveeSelect.addEventListener("change", updateHeures);

// --- Popup & format date ---
function formatDateFrancais(dateStr, heureStr){
  const date=new Date(dateStr+"T"+heureStr);
  const options={ day:"2-digit", month:"long", year:"numeric" };
  return date.toLocaleDateString("fr-FR",options)+` à ${date.getHours().toString().padStart(2,"0")}h${date.getMinutes().toString().padStart(2,"0")}`;
}
function showPopup(message){
  const popup=document.createElement("div"); popup.classList.add("popup");
  popup.innerHTML=`<div class="popup-content">${message}<button id="closePopup">OK</button></div>`;
  document.body.appendChild(popup);
  document.getElementById("closePopup").addEventListener("click",()=>popup.remove());
}

// --- Soumission formulaire ---
const form=document.getElementById("reservationForm");
form.addEventListener("submit", async e=>{
  e.preventDefault();
  const formData=new FormData(form);
  const reservation={
    nom_proprietaire: formData.get("nom_proprietaire"),
    email: formData.get("email"),
    nb_chien: parseInt(formData.get("nb_chien"))||1,
    nom_chien: [],
    date_arrivee: formData.get("date_arrivee"),
    heure_arrivee: formData.get("heure_arrivee"),
    date_depart: formData.get("date_depart"),
    heure_depart: formData.get("heure_depart"),
    remarque: formData.get("remarque")
  };
  for(let i=1;i<=reservation.nb_chien;i++) reservation.nom_chien.push(formData.get(`nom_chien_input_${i}`));
  reservation.nom_chien=reservation.nom_chien.join(",");

  try{
    const {error}=await supabaseClient.from("reservations").insert([reservation]);
    if(error){ alert("Erreur en base : "+error.message); return; }
  } catch(err){ alert("Erreur en base : "+(err.message||err)); return; }

  const messageHtml=`Votre réservation a été enregistrée avec succès<br>
  <div style="margin-left:20px;">
  du <strong>${formatDateFrancais(reservation.date_arrivee,reservation.heure_arrivee)}</strong><br>
  au <strong>${formatDateFrancais(reservation.date_depart,reservation.heure_depart)}</strong>
  </div><br>Nous vous tiendrons informé(e) dès que possible de la disponibilité.<br><br`;
  showPopup(messageHtml);

  // EmailJS
  const emailParams={
    from_name: "Isabelle - Pension À l'Orée de la Forêt",
    from_email: "a.l.oree.de.la.foret.37@gmail.com",
    to_name: reservation.nom_proprietaire,
    to_email: reservation.email,
    subject: "Votre réservation a bien été enregistrée",
    message:`Votre réservation a été enregistrée du ${formatDateFrancais(reservation.date_arrivee,reservation.heure_arrivee)} au ${formatDateFrancais(reservation.date_depart,reservation.heure_depart)}`
  };
  try{ await emailjs.send("service_22ypgkl","template_i2nke5k",emailParams); } catch(err){ console.error("Erreur EmailJS :",err); }

  form.reset(); dateArriveeInput.value=todayStr; dateDepartInput.value=todayStr;
  updateNomsChiens(); updateHeures();
});
updateHeures();
</script>
</body>
</html>
